<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ ªå¼ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button, label, select, datalist { margin: 5px; }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }
    table { border-collapse: collapse; min-width: 1000px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; cursor: pointer; }
    .profit { color: green; }
    .loss { color: red; }
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="icon-192.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("âœ… Service Worker ç™»éŒ²æˆåŠŸ"))
        .catch(err => console.error("âŒ Service Worker ç™»éŒ²å¤±æ•—", err));
    }
  </script>
</head>
<body>

<h3>æ ªå¼ç®¡ç†ãƒ„ãƒ¼ãƒ«</h3>
<div>
  <input list="codeList" type="text" id="code" placeholder="éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (ä¾‹: 7203.T)" oninput="validateCode(this)">
  <datalist id="codeList"></datalist>
  <input list="amountList" type="number" id="amount" placeholder="ä¿æœ‰æ•°" min="1">
  <datalist id="amountList">
    <script>
      for (let i = 100; i <= 2000; i += 100) {
        document.write(`<option value="${i}">`);
      }
    </script>
  </datalist>
  <input type="number" id="price" placeholder="å–å¾—å˜ä¾¡ (å††)">
  <button onclick="addStock()">è¿½åŠ </button>
  <br><br>
  <input type="text" id="search" placeholder="ğŸ” éŠ˜æŸ„æ¤œç´¢" oninput="renderStocks()">
  <br><br>
  <button onclick="exportCSV()">ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <input type="file" id="csvFile" onchange="importCSV(event)">
  <label for="csvFile">ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
</div>

<hr>

<h3>ä¿æœ‰éŠ˜æŸ„ä¸€è¦§</h3>
<div class="table-wrapper">
  <div id="stockList"></div>
</div>
<div id="summary"></div>

<!-- doGet()ã®çµæœã‚’1æ—¥1å›æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã‚‹JSONãƒ‡ãƒ¼ã‚¿ -->
<script id="stock-data-json" type="application/json">
{
  "7203.T": {
    "name": "ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š",
    "dividend": 60,
    "shareholderBenefits": [[100,1000],[200,3000]],
    "price": 3200
  },
  "9984.T": {
    "name": "ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G",
    "dividend": 0,
    "shareholderBenefits": [[100,1000],[200,3000]],
    "price": 7800
  }
}
</script>

<script>
  let stockDataCache = null;
  let sortColumn = null;
  let sortAsc = true;

  function validateCode(input) {
    input.value = input.value.toUpperCase().replace(/[^A-Z0-9.]/g, "");
  }

  function fetchStockData() {
    try {
      const rawJson = document.getElementById("stock-data-json").textContent;
      stockDataCache = JSON.parse(rawJson);
      const datalist = document.getElementById("codeList");
      datalist.innerHTML = "";
      for (const code in stockDataCache) {
        const name = stockDataCache[code].name || "";
        const option = document.createElement("option");
        option.value = code;
        option.text = `${code} - ${name}`;
        datalist.appendChild(option);
      }
    } catch (e) {
      alert("ğŸ“‰ æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }

  function getBenefitForAmount(benefitList, amount) {
   let benefitsArray = benefitList;
  
    if (typeof benefitsArray === "string") {
      try {
        benefitsArray = JSON.parse(benefitsArray);
      } catch (e) {
        return "â€•";
      }
    }
    
    if (!Array.isArray(benefitsArray)) return "â€•";
    
    let result = "â€•";
    for (const [required, value] of benefitsArray) {
      if (amount >= required) result = `${value}å††`;
    }
    return result;
  }

  function renderStocks() {
    const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
    const keyword = document.getElementById("search").value.trim().toUpperCase();
    let filtered = stockList.filter(item => item.code.includes(keyword));

    if (sortColumn) {
      filtered.sort((a, b) => {
        const valA = a[sortColumn];
        const valB = b[sortColumn];
        return sortAsc ? valA - valB : valB - valA;
      });
    }

    const container = document.getElementById("stockList");
    let html = `
      <table>
        <thead>
          <tr>
            <th onclick="setSort('code')">ã‚³ãƒ¼ãƒ‰</th>
            <th>éŠ˜æŸ„å</th>
            <th onclick="setSort('amount')">ä¿æœ‰æ•°</th>
            <th onclick="setSort('price')">å–å¾—å˜ä¾¡</th>
            <th>ç¾åœ¨å€¤</th>
            <th>è©•ä¾¡é¡</th>
            <th>ä¿æœ‰ç·é¡</th>
            <th>æç›Š</th>
            <th>æç›Šç‡</th>
            <th>é…å½“åˆ©å›ã‚Š</th>
            <th>å„ªå¾…</th>
            <th>å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody>`;

    let totalProfit = 0;
    let totalDividend = 0;
    let totalEvaluation = 0;

    filtered.forEach((item, i) => {
      const info = stockDataCache[item.code] || {};
      const currentPrice = info.price || 0;
      const marketValue = currentPrice * item.amount;
      const cost = item.price * item.amount;
      const profit = marketValue - cost;
      const profitRate = cost > 0 ? (profit / cost * 100).toFixed(2) : "â€•";
      const dividend = info.dividend || 0;
      const annualDividend = marketValue * (dividend / 100);
      totalProfit += profit;
      totalDividend += annualDividend;
      totalEvaluation += marketValue;

      html += `
        <tr>
          <td>${item.code}</td>
          <td>${info.name || "â€•"}</td>
          <td>${item.amount}</td>
          <td>${item.price.toLocaleString()}å††</td>
          <td>${currentPrice ? currentPrice.toLocaleString() + "å††" : "â€•"}</td>
          <td>${marketValue.toLocaleString()}å††</td>
          <td>${cost.toLocaleString()}å††</td>
          <td class="${profit >= 0 ? 'profit' : 'loss'}">${profit.toLocaleString()}å††</td>
          <td class="${profit >= 0 ? 'profit' : 'loss'}">${profitRate}%</td>
          <td>${dividend ? (dividend) + "%" : "â€•"}</td>
          <td>${getBenefitForAmount(info.shareholderBenefits, item.amount)}</td>
          <td><button onclick="deleteStock(${i})" class="text-red-500 hover:underline">å‰Šé™¤</button></td>
        </tr>`;
    });

    html += `</tbody></table>`;

    container.innerHTML = html;
    document.getElementById("summary").innerHTML = `
      <br>
      <div><strong>åˆè¨ˆæç›Š:</strong> <span class="${totalProfit >= 0 ? 'profit' : 'loss'}">${totalProfit.toLocaleString()}å††</span></div>
      <div><strong>å¹´é–“é…å½“è¦‹è¾¼ã¿:</strong> ${totalDividend.toLocaleString()}å††</div>
      <div><strong>è©•ä¾¡é¡åˆè¨ˆ:</strong> ${totalEvaluation.toLocaleString()}å††</div>`;
  }

  function setSort(column) {
    if (sortColumn === column) {
      sortAsc = !sortAsc;
    } else {
      sortColumn = column;
      sortAsc = true;
    }
    renderStocks();
  }

  function addStock() {
    const code = document.getElementById("code").value.trim().toUpperCase();
    const amount = parseInt(document.getElementById("amount").value);
    const price = parseFloat(document.getElementById("price").value);
    if (!code || isNaN(amount) || isNaN(price)) {
      alert("âš ï¸ å…¥åŠ›å†…å®¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    if (!stockDataCache || !stockDataCache[code]) {
      alert("âš ï¸ éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
      return;
    }
    const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
    stockList.push({ code, amount, price });
    localStorage.setItem("myStockList", JSON.stringify(stockList));
    document.getElementById("code").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("price").value = "";
    renderStocks();
  }

  function deleteStock(index) {
    const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
    stockList.splice(index, 1);
    localStorage.setItem("myStockList", JSON.stringify(stockList));
    renderStocks();
  }

  function exportCSV() {
    const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
    const csv = stockList.map(item => `${item.code},${item.amount},${item.price}`).join("\n");
    const blob = new Blob(["code,amount,price\n" + csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "myStockList.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
    if (!file.name.endsWith(".csv")) {
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const lines = reader.result.split("\n").slice(1);
      const stockList = lines
        .map(line => {
          const [code, amount, price] = line.split(",");
          return { code: code.trim(), amount: parseInt(amount), price: parseFloat(price) };
        })
        .filter(item => item.code && !isNaN(item.amount) && !isNaN(item.price));
      localStorage.setItem("myStockList", JSON.stringify(stockList));
      renderStocks();
    };
    reader.readAsText(file);
  }

  fetchStockData();
  renderStocks();
</script>
</body>
</html>
