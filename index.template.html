<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>株式管理ツール</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button, label, select, datalist { margin: 5px; }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }
    table { border-collapse: collapse; min-width: 800px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; cursor: pointer; }
    .profit { color: green; }
    .loss { color: red; }
  </style>
</head>
<body>

<h3>株式管理ツール</h3>
<div>
  <input list="codeList" type="text" id="code" placeholder="銘柄コード (例: 7203.T)" oninput="validateCode(this)">
  <datalist id="codeList"></datalist>
  <input list="amountList" type="number" id="amount" placeholder="保有数" min="1">
  <datalist id="amountList">
    <script>
      for (let i = 100; i <= 2000; i += 100) {
        document.write(`<option value="${i}">`);
      }
    </script>
  </datalist>
  <input type="number" id="price" placeholder="取得単価 (円)">
  <button onclick="addStock()">追加</button>
  <br><br>
  <input type="text" id="search" placeholder="🔍 銘柄検索" oninput="renderStocks()">
  <br><br>
  <button onclick="exportCSV()">📤 CSVエクスポート</button>
  <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)">
  <label for="csvFile">📥 CSVインポート</label>
</div>

<hr>

<h3>保有銘柄一覧</h3>
<div class="table-wrapper">
  <div id="stockList"></div>
</div>
<div id="summary"></div>

<!-- doGet()の結果を1日1回手動で貼り付けるJSONデータ -->
<script id="stock-data-json" type="application/json">
{
  "7203.T": {
    "name": "トヨタ自動車",
    "dividend": 60,
    "shareholderBenefits": "あり",
    "price": 3200
  },
  "9984.T": {
    "name": "ソフトバンクG",
    "dividend": 0,
    "shareholderBenefits": "なし",
    "price": 7800
  }
}
</script>

<script>
let currentSortKey = "";
let currentSortOrder = "asc";
let stockDataCache = null;

function validateCode(input) {
  input.value = input.value.toUpperCase().replace(/[^A-Z0-9.]/g, "");
}

function fetchStockData() {
  try {
    const rawJson = document.getElementById("stock-data-json").textContent;
    stockDataCache = JSON.parse(rawJson);
    const datalist = document.getElementById("codeList");
    datalist.innerHTML = "";
    for (const code in stockDataCache) {
      const name = stockDataCache[code].name || "";
      const option = document.createElement("option");
      option.value = code;
      option.text = `${code} - ${name}`;
      datalist.appendChild(option);
    }
  } catch (e) {
    alert("埋め込み株価データの読み込みに失敗しました。");
  }
}

function addStock() {
  const code = document.getElementById("code").value.trim().toUpperCase();
  const amount = parseInt(document.getElementById("amount").value);
  const price = parseFloat(document.getElementById("price").value);

  if (!code || isNaN(amount) || isNaN(price)) {
    alert("正しく入力してください。");
    return;
  }

  if (!stockDataCache[code]) {
    alert("銘柄コードが存在しません。");
    return;
  }

  const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
  stockList.push({ code, amount, price });
  localStorage.setItem("myStockList", JSON.stringify(stockList));

  document.getElementById("code").value = "";
  document.getElementById("amount").value = "";
  document.getElementById("price").value = "";

  renderStocks();
}

function renderStocks() {
  const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
  const keyword = document.getElementById("search").value.trim().toUpperCase();
  const filteredList = stockList.filter(item => item.code.includes(keyword));
  const container = document.getElementById("stockList");
  const summary = document.getElementById("summary");

  if (filteredList.length === 0) {
    container.innerHTML = "<p>保有銘柄がありません。</p>";
    summary.innerHTML = "";
    return;
  }

  let processed = filteredList.map((item, index) => {
    const info = stockDataCache[item.code] || {};
    const current = parseFloat(info.price) || 0;
    const name = info.name || "―";
    const dividend = info.dividend || 0;
    const benefit = info.shareholderBenefits || "―";
    const diff = (current - item.price) * item.amount;
    const rate = current && item.price ? ((current - item.price) / item.price * 100) : 0;
    return {
      ...item, name, current, dividend, benefit, diff, rate, index
    };
  });

  if (currentSortKey) {
    processed.sort((a, b) => {
      const valA = a[currentSortKey];
      const valB = b[currentSortKey];
      if (typeof valA === 'string') {
        return currentSortOrder === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
      }
      return currentSortOrder === "asc" ? valA - valB : valB - valA;
    });
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('code')">コード</th>
          <th onclick="sortBy('name')">名称</th>
          <th onclick="sortBy('amount')">保有数</th>
          <th onclick="sortBy('price')">取得単価</th>
          <th onclick="sortBy('current')">現在値</th>
          <th onclick="sortBy('dividend')">配当金</th>
          <th onclick="sortBy('benefit')">優待</th>
          <th onclick="sortBy('diff')">損益</th>
          <th onclick="sortBy('rate')">損益率</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
  `;

  let totalHold = 0, totalEval = 0, totalDividend = 0;

  processed.forEach(item => {
    const profitColor = item.diff > 0 ? "profit" : (item.diff < 0 ? "loss" : "");
    const diffStr = isNaN(item.diff) ? "―" : (item.diff >= 0 ? "+" : "") + item.diff.toLocaleString("ja-JP") + "円";
    const rateStr = isNaN(item.rate) ? "―" : item.rate.toFixed(2) + "%";

    html += `
      <tr>
        <td>${item.code}</td>
        <td>${item.name}</td>
        <td>${item.amount}</td>
        <td>${item.price.toLocaleString("ja-JP")}円</td>
        <td>${item.current.toLocaleString("ja-JP")}円</td>
        <td>${item.dividend}</td>
        <td>${item.benefit}</td>
        <td class="${profitColor}">${diffStr}</td>
        <td class="${profitColor}">${rateStr}</td>
        <td><button onclick="deleteStock(${item.index})">削除</button></td>
      </tr>
    `;

    totalHold += item.amount * item.price;
    totalEval += item.amount * item.current;
    totalDividend += item.dividend * item.amount;
  });

  html += "</tbody></table>";
  container.innerHTML = html;

  const totalProfit = totalEval - totalHold;
  const profitColor = totalProfit > 0 ? "green" : (totalProfit < 0 ? "red" : "black");

  summary.innerHTML = `
    <p>
      🔸 保有総額: ${totalHold.toLocaleString()}円｜
      🔸 評価額: ${totalEval.toLocaleString()}円｜
      🔸 合計損益: <strong style="color:${profitColor}">${(totalProfit >= 0 ? "+" : "") + totalProfit.toLocaleString()}円</strong>｜
      🔸 年間配当見込: ${totalDividend.toLocaleString()}円
    </p>
  `;
}

// 初回データ読み込み
fetchStockData();
renderStocks();
  
function deleteStock(index) {
  const stockList = JSON.parse(localStorage.getItem("myStockList") || "[]");
  if (index >= 0 && index < stockList.length) {
    stockList.splice(index, 1);
    localStorage.setItem("myStockList", JSON.stringify(stockList));
    renderStocks();
  }
}
</script>
</body>
</html>
